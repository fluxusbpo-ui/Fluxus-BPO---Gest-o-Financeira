name: Supabase Migration

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      PG_CONN: ${{ secrets.PG_CONN }}
      APPLY_RLS: ${{ secrets.APPLY_RLS }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 postgresql-client dnsutils iproute2 netcat-openbsd

      - name: Diagnose DB connectivity
        run: |
          echo "SUPABASE_URL=$SUPABASE_URL"
          echo "PG_CONN=${PG_CONN}" | sed -E 's/(password=)[^ ]+/\1***REDACTED***/g'
          echo "Resolving DNS records for DB host..."
          host=$(echo "$PG_CONN" | sed -E 's@.*//([^:/]+).*@\1@')
          echo "DB host: $host"
          echo "Using installed tools: dig, ip, nc"
          echo "A records:"; A=$(dig +short A $host | head -n1) || true; echo "$A"
          echo "AAAA records:"; AAAA=$(dig +short AAAA $host | head -n1) || true; echo "$AAAA"
          echo "Parsing PG_CONN for credentials and database..."
          userpass_host_db=$(echo "$PG_CONN" | sed -E 's@^[^/]+//@@')
          userpass=$(echo "$userpass_host_db" | cut -d'@' -f1)
          hostportdb=$(echo "$userpass_host_db" | cut -d'@' -f2)
          username=$(echo "$userpass" | cut -d: -f1)
          password=$(echo "$userpass" | cut -d: -f2-)
          hostport=$(echo "$hostportdb" | cut -d/ -f1)
          dbname=$(echo "$hostportdb" | cut -d/ -f2-)
          port=$(echo "$hostport" | cut -d: -f2)
          echo "  Parsed user=${username} db=${dbname} port=${port}"
          export PGPASSWORD="$password"
          if [ -n "$A" ]; then
            echo "Testing IPv4 connectivity to $A:$port"
            if nc -vz -w 5 $A $port >/dev/null 2>&1; then
              echo "OK (IPv4 reachable)"
              echo "DB_REACHABLE=ipv4" >> $GITHUB_ENV
              echo "DB_IPV4=$A" >> $GITHUB_ENV
            else
              echo "IPv4 not reachable"
            fi
          fi
          if [ -n "$AAAA" ]; then
            echo "Testing IPv6 connectivity to $AAAA:$port"
            if nc -vz -w 5 -6 $AAAA $port >/dev/null 2>&1; then
              echo "OK (IPv6 reachable)"
              # If IPv4 already set as reachable, mark both reachable
              if [ "${DB_REACHABLE:-}" = "ipv4" ]; then
                echo "DB_REACHABLE=both" >> $GITHUB_ENV
              else
                echo "DB_REACHABLE=ipv6" >> $GITHUB_ENV
              fi
              echo "DB_IPV6=$AAAA" >> $GITHUB_ENV
            else
              echo "IPv6 not reachable"
            fi
          fi
          if [ -z "${DB_REACHABLE:-}" ]; then
            echo "DB not reachable from runner (no IPv4/IPv6). Will attempt Supabase CLI fallback later."
            echo "DB_REACHABLE=none" >> $GITHUB_ENV
          fi

      - name: Apply SQL migrations
        run: |
          set -euo pipefail
          # Parse PG_CONN for credentials and DB
          userpass_host_db=$(echo "$PG_CONN" | sed -E 's@^[^/]+//@@')
          userpass=$(echo "$userpass_host_db" | cut -d'@' -f1)
          hostportdb=$(echo "$userpass_host_db" | cut -d'@' -f2)
          username=$(echo "$userpass" | cut -d: -f1)
          password=$(echo "$userpass" | cut -d: -f2-)
          hostport=$(echo "$hostportdb" | cut -d/ -f1)
          dbname=$(echo "$hostportdb" | cut -d/ -f2-)
          port=$(echo "$hostport" | cut -d: -f2)
          export PGPASSWORD="$password"
          if [ "${DB_REACHABLE:-}" = "ipv4" ] || [ "${DB_REACHABLE:-}" = "both" ]; then
            hostip="$DB_IPV4"
          elif [ "${DB_REACHABLE:-}" = "ipv6" ]; then
            hostip="$DB_IPV6"
          else
            echo "No reachable DB IP found, attempting Supabase CLI fallback"
            # Install supabase CLI via supported installer (deb/tarball)
            echo "Installing Supabase CLI via supported installer..."
            (curl -sL https://deb.supabase.com/cli/install | sh) || (
              echo "deb installer failed, trying tarball..." && curl -sL "https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz" | tar -xz -C /usr/local/bin supabase
            ) || { echo "Failed to install Supabase CLI"; exit 1; }
            # Determine project ref
            if [ -n "${SUPABASE_PROJECT_REF:-}" ]; then
              PROJECT_REF="$SUPABASE_PROJECT_REF"
            else
              if [ -z "${SUPABASE_URL:-}" ]; then
                echo "SUPABASE_URL or SUPABASE_PROJECT_REF must be set for Supabase CLI fallback"; exit 1
              fi
              PROJECT_REF=$(echo "$SUPABASE_URL" | sed -E 's@https?://@@' | cut -d '.' -f1)
            fi
            echo "Using Project ref: $PROJECT_REF"
            supabase login --access-token "$SUPABASE_ACCESS_TOKEN"
            supabase link --project-ref "$PROJECT_REF"
            # Push local migrations using supabase CLI
            supabase db push --project-ref "$PROJECT_REF" --no-verify || {
              echo "Supabase CLI fallback failed"; exit 1
            }
          fi
          echo "Connecting to DB via host ip: $hostip port: $port user: $username db: $dbname"
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120301_create_empresas.sql"
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120302_create_planos.sql"
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120303_create_usuarios.sql"
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120304_create_assinaturas.sql"
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120402_add_email_tokens_and_flag.sql"
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120305_update_planos_schema.sql"
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120501_add_cpf_to_usuarios.sql"
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120502_add_owner_empresa_to_empresas.sql"
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120401_add_checkout_sessionid_to_assinaturas.sql"
          if [ "${APPLY_RLS}" = "true" ]; then
            echo "Applying RLS policies (APPLY_RLS=true)"
            psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120601_rls_policies.sql"
          else
            echo "Skipping RLS policies (set secret APPLY_RLS=true to apply)"
          fi
          psql -h "$hostip" -p "$port" -U "$username" -d "$dbname" -v ON_ERROR_STOP=1 -f "supabase/migrations/2025120602_add_data_to_empresas.sql"

      - name: Import data from SQLite to Postgres
        env:
          PG_CONN: ${{ secrets.PG_CONN }}
        run: bash scripts/ci_migrate.sh
