name: Supabase Migration

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    env:
      PG_CONN: ${{ secrets.PG_CONN }}
      APPLY_RLS: ${{ secrets.APPLY_RLS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sqlite3 postgresql-client

      - name: Diagnose DB connectivity
        run: |
          echo "SUPABASE_URL=$SUPABASE_URL"
          echo "PG_CONN=${PG_CONN}" | sed -E 's/(password=)[^ ]+/\1***REDACTED***/g'
          echo "Resolving DNS records for DB host..."
          host=$(echo "$PG_CONN" | sed -E 's@.*@(.*):(.*)@\1@' | sed -E 's@.*//@@' | sed -E 's/:.*$//' )
          echo "DB host: $host"
          apt-get update && apt-get install -y dnsutils iproute2 netcat
          echo "A records:"; dig +short A $host || true
          echo "AAAA records:"; dig +short AAAA $host || true
          echo "Connectivity checks:";
          echo "  IPv4 (psql -4) ->"; psql -4 -c '\l' "$PG_CONN" >/dev/null 2>&1 && echo "OK (IPv4)" || echo "FAILED (IPv4)";
          echo "  IPv6 (psql -6) ->"; psql -6 -c '\l' "$PG_CONN" >/dev/null 2>&1 && echo "OK (IPv6)" || echo "FAILED (IPv6)";

      - name: Apply SQL migrations
        run: |
          # Force IPv4 and stop on error for clearer failures on GitHub Actions runners
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120301_create_empresas.sql"
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120302_create_planos.sql"
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120303_create_usuarios.sql"
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120304_create_assinaturas.sql"
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120402_add_email_tokens_and_flag.sql"
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120305_update_planos_schema.sql"
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120501_add_cpf_to_usuarios.sql"
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120502_add_owner_empresa_to_empresas.sql"
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120401_add_checkout_sessionid_to_assinaturas.sql"
          if [ "${APPLY_RLS}" = "true" ]; then
            echo "Applying RLS policies (APPLY_RLS=true)"
            psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120601_rls_policies.sql"
          else
            echo "Skipping RLS policies (set secret APPLY_RLS=true to apply)"
          fi
          psql -4 -v ON_ERROR_STOP=1 "$PG_CONN" -f "supabase/migrations/2025120602_add_data_to_empresas.sql"

      - name: Import data from SQLite to Postgres
        env:
          PG_CONN: ${{ secrets.PG_CONN }}
        run: bash scripts/ci_migrate.sh
